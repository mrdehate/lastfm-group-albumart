function Constants(){this.LASTFM_API_KEY="e63ca8d5b65415a4ee36b32260dce956",this.ECHONEST_API_KEY="TU0XNU2PKBGD5AIJ2",this.THE_GROUP="WorkForce Software",this.BLANK_COVER_URL="http://upload.wikimedia.org/wikipedia/commons/b/b9/No_Cover.jpg",this.REFRESH_INTERVAL=6e4,this.DAY_REFRESH_INTERVAL=864e5}function Listen(t,r){function a(){var t="";return""===t&&(t=s(),""===t&&(t=n(),""===t&&(t=e(),""===t&&(t=o.BLANK_COVER_URL)))),t}function e(){var t="";return $.ajax({url:"http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&artist="+encodeURIComponent(i.artist)+"&api_key="+o.LASTFM_API_KEY+"&format=json",async:!1}).done(function(r){try{t=r.artist.image[2]["#text"]}catch(a){}i.apiCount++,r=null}),t}function s(){if(""===i.albumMBID||null===i.albumMBID)return"";var t="";return $.ajax({url:"http://coverartarchive.org/release/"+i.albumMBID,async:!1}).done(function(r){try{t=r.images.thumbnails.small["#text"]}catch(a){}r=null}),t}function n(){if(""===i.artist||null===i.artist||""===i.song||null===i.song)return"";var t="";return $.ajax({url:"http://developer.echonest.com/api/v4/song/search?api_key="+o.ECHONEST_API_KEY+"&format=json&results=1&artist="+encodeURIComponent(i.artist)+"&title="+encodeURIComponent(i.song)+"&bucket=id:7digital-US&bucket=tracks",async:!1}).done(function(r){try{t=r.response.songs[0].tracks[0].release_image}catch(a){}}),t}this.userName=t,this.artist="",this.song="",this.albumArt="",this.nowPlaying=!1,this.albumMBID="",this.valid=!0,this.apiCount=0;var i=this,o=r;$.ajax({url:"http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user="+this.userName+"&limit=2&api_key="+o.LASTFM_API_KEY+"&format=json",async:!1}).done(function(t){if(this.apiCount++,void 0===t.recenttracks||void 0===t.recenttracks.track)return 0;try{i.artist=t.recenttracks.track[0].artist["#text"],i.song=t.recenttracks.track[0].name,i.albumArt=t.recenttracks.track[0].image[3]["#text"],i.albumMBID=t.recenttracks.track[0].album.mbid,t.recenttracks.track[0]&&t.recenttracks.track[0]["@attr"]&&t.recenttracks.track[0]["@attr"].nowplaying&&(i.nowPlaying="true"===t.recenttracks.track[0]["@attr"].nowplaying)}catch(r){i.valid=!1}t=null}),""===this.albumArt&&this.nowPlaying&&(this.albumArt=a()),gApiCallCounter+=this.apiCount}function Artist(t,r){this.artist=t.name,this.mbid=t.mbid,this.totalPlaycount=t.playcount,this.uniqueUsers=1;var a=this,e=r}function processListen(t,r){if(t.nowPlaying){var a="";a="<div class='entry'>",a+="<div class='user'>"+t.userName+"</div>",a+="<div class='artistOuter'><span class='artist'>"+t.artist+"</span></div>",a+="<div class='songOuter'><span class='song'>"+t.song+"</span></div>",a+="<img class='imgArt' src='"+t.albumArt+"' /><br />",a+="</div>",$("."+r).append(a)}}function getArtistChart(){var t=new Constants,r="http://ws.audioscrobbler.com/2.0/?method=group.getweeklyartistchart&api_key="+t.LASTFM_API_KEY+"&group="+t.THE_GROUP+"&format=json";return $.getJSON(r,function(t){var r=new Date,a=new Date;try{r.setTime(1e3*t.weeklyartistchart["@attr"].from),a.setTime(1e3*t.weeklyartistchart["@attr"].to)}catch(e){r=null,a=null}$(".artistChart h3").html(""),r&&a&&$(".artistChart h3").html($.datepicker.formatDate("M dd",r)+" - "+$.datepicker.formatDate("M dd",a));for(var s=new Array,n=0;t.weeklyartistchart.artist[n]&&t.weeklyartistchart.artist[n].playcount&&t.weeklyartistchart.artist[n].playcount>1;)s[n]=t.weeklyartistchart.artist[n].name,n++;$(".artistChart ol").html("");var i;for(i=0;25>i&&void 0!==s[i];i++)$(".artistChart ol").append("<li>"+s[i]+"</li>");gApiCallCounter++,t=null}),!0}function getUsersArtistChart(t){var r=new Constants,a=new Array;return $.ajax({url:"http://ws.audioscrobbler.com/2.0/?method=user.getTopArtists&period=7day&api_key="+r.LASTFM_API_KEY+"&user="+t+"&format=json&limit=200",async:!1}).done(function(t){var r=0;if(t&&t.topartists&&t.topartists.artist)for(;t.topartists.artist[r];)a[r]=new Artist(t.topartists.artist[r]),r++}),a}function getCustomArtistChart(){var t=new Constants,r="http://ws.audioscrobbler.com/2.0/?method=group.getmembers&api_key="+t.LASTFM_API_KEY+"&group="+t.THE_GROUP+"&format=json";return $.getJSON(r,function(t){for(var r=new Array,a=new Array,e=0;t.members.user[e];)a[e]=getUsersArtistChart(t.members.user[e].name),e++;var s=[];s=s.concat.apply(s,a),e=0;for(var n=[],i,o;s[e];){for(i=!1,o=0;o<n.length&&!i;)n[o]&&s[e]&&s[e].artist&&n[o].artist&&n[o].artist===s[e].artist&&(i=!0,n[o].uniqueUsers++,n[o].totalPlaycount=Number(n[o].totalPlaycount)+Number(s[e].totalPlaycount)),o++;i||n.push(s[e]),e++}for(n.sort(function(t,r){return parseFloat(r.uniqueUsers)-parseFloat(t.uniqueUsers)}),e=0,i=!1;e<n.length&&!i;)1===n[e].uniqueUsers&&(n.splice(e,Number.MAX_VALUE),i=!0),e++;var u=new Date,c=new Date;for(c.setDate(c.getDate()-7),$(".artistChart h3").html($.datepicker.formatDate("M dd",c)+" - "+$.datepicker.formatDate("M dd",u)),$(".artistChart ol").html(""),o=0;25>o&&void 0!==n[o];o++)$(".artistChart ol").append("<li>"+n[o].artist+" <span class='unique'>"+n[o].uniqueUsers+"</span></li>")}),!0}function updateApiCounter(){$(".stats").html("API/sec: "+(gApiCallCounter/((Date.now()-gStartupTime)/1e3)).toFixed(2))}function main(){var t=new Constants,r=new Array,a="http://ws.audioscrobbler.com/2.0/?method=group.getmembers&api_key="+t.LASTFM_API_KEY+"&group="+t.THE_GROUP+"&format=json";return $.getJSON(a,function(a){for(var e=0;a.members.user[e];)r[e]=new Listen(a.members.user[e].name,t),e++;$(".cover").html("");for(var s=0;r[s];)processListen(r[s],"cover"),s++;$(".updateTime").html((new Date).toLocaleTimeString()),gApiCallCounter++,a=null}),!0}var gApiCallCounter=0,gStartupTime=Date.now();$(document).ready(function(){$(".groupName").html("What "+(new Constants).THE_GROUP+" is Listening To Right Now")}),setInterval(main,(new Constants).REFRESH_INTERVAL),setInterval(updateApiCounter,(new Constants).REFRESH_INTERVAL),getCustomArtistChart(),setInterval(getCustomArtistChart,(new Constants).DAY_REFRESH_INTERVAL);